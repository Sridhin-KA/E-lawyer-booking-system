<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Call Room</title>
    <style>
        body { display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column;}
        .video-container { display: flex; justify-content: center; gap: 20px; }
        video { width: 45%; height: auto; border: 1px solid #ccc; border-radius: 10px; }
        .controls { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #45a049; }
    </style>
</head>
<body>

<h1>Room: {{ room_number }}</h1>
<h2>{{ lawyer.first_name }}'s Video Call</h2>

<div class="video-container">
    <video id="local-video" autoplay muted></video>
    <video id="remote-video" autoplay></video>
</div>

<div class="controls">
    <button id="mute-btn">Mute</button>
    <button id="video-btn">Turn Video Off</button>
    <button id="end-call-btn">End Call</button>
</div>

<!-- PeerJS CDN -->
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.3.1/dist/peerjs.min.js"></script>

<script>
    const roomId = "{{ room_number }}";  // Unique shared ID between lawyer and client
    console.log("Room ID:", roomId);
    
    const localVideo = document.getElementById('local-video');
    const remoteVideo = document.getElementById('remote-video');
    const muteBtn = document.getElementById('mute-btn');
    const videoBtn = document.getElementById('video-btn');
    const endCallBtn = document.getElementById('end-call-btn');

    let localStream;
    let call;
    let isMuted = false;
    let isVideoOff = false;

    // PeerJS initialization (can use PeerServer or custom server)
    const peer = new Peer(roomId, {
        host: '/',         // Adjust to your PeerServer config
        port: 9000,
        path: '/peerjs'
    });

    peer.on('open', id => {
        console.log('Lawyer Peer ID:', id);
        getUserMediaAndWaitForCall();
    });

    function getUserMediaAndWaitForCall() {
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
            localStream = stream;
            localVideo.srcObject = localStream;

            // Wait for incoming call from client
            peer.on('call', incomingCall => {
                incomingCall.answer(localStream); // Answer with lawyer's stream
                call = incomingCall;

                incomingCall.on('stream', remoteStream => {
                    remoteVideo.srcObject = remoteStream;
                });

                incomingCall.on('close', () => {
                    remoteVideo.srcObject = null;
                });
            });

        }).catch(err => {
            console.error('Failed to get media', err);
        });
    }

    muteBtn.addEventListener('click', () => {
        isMuted = !isMuted;
        localStream.getAudioTracks().forEach(track => track.enabled = !isMuted);
        muteBtn.textContent = isMuted ? 'Unmute' : 'Mute';
    });

    videoBtn.addEventListener('click', () => {
        isVideoOff = !isVideoOff;
        localStream.getVideoTracks().forEach(track => track.enabled = !isVideoOff);
        videoBtn.textContent = isVideoOff ? 'Turn Video On' : 'Turn Video Off';
    });

    endCallBtn.addEventListener('click', () => {
        if (call) call.close();
        if (localStream) localStream.getTracks().forEach(track => track.stop());
        window.location.href = '/lhome';
    });
</script>

</body>
</html>
