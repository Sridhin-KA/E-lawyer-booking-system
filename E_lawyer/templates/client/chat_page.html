{% extends 'home/base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar with Lawyer Info -->
        <div class="col-md-4 bg-light border-end vh-100 d-flex flex-column justify-content-between">
            <div>
                <h4 class="p-3">Lawyer</h4>
                <div class="p-3">
                    <strong>{{ lawyer.first_name }} {{ lawyer.last_name }}</strong><br>
                    <small>{{ lawyer.category }}</small>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="col-md-8 d-flex flex-column vh-100">
            <!-- Header with video call button -->
            <div class="d-flex justify-content-between align-items-center border-bottom p-3">
                <h5 class="m-0">Chat with {{ lawyer.first_name }}</h5>
                {% if lawyer.id %}
                    <a href="{% url 'client:start_video_call' lawyer_id=lawyer.id.id %}" class="btn btn-outline-primary btn-sm">
                        Start Video Call
                    </a>
                {% else %}
                    <span class="text-danger">No user assigned</span>
                {% endif %}
            </div>

            <!-- Chat Box with scrollable messages -->
            <div id="chatMessages" class="flex-grow-1 chat-box" style="overflow-y: auto; height: 400px; border: 1px solid #ddd; padding: 10px;">
                {% if messages %}
                    {% for message in messages %}
                        <p>
                            <strong><b>{{ message.sender.first_name }} {{ message.sender.last_name }}:</strong> {{ message.message }}</b>
                            <small class="text-muted float-end">{{ message.timestamp|date:"H:i" }}</small>
                        </p>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No messages yet.</p>
                {% endif %}
            </div>

            <!-- Chat Input -->
            <form method="post" action="{% url 'client:client_chat' lawyer_id=lawyer.id.id %}" class="send-message p-3 border-top">
                {% csrf_token %}
                <textarea name="message" placeholder="Type your message..." required class="form-control"></textarea>
                <button type="submit" class="btn btn-primary mt-2">Send</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal for incoming call -->
<div class="modal" tabindex="-1" id="incomingCallModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Incoming Video Call</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You have an incoming call from the lawyer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" id="acceptCallBtn" class="btn btn-primary">Accept</button>
                <button type="button" id="rejectCallBtn" class="btn btn-secondary" data-bs-dismiss="modal">Reject</button>
            </div>
        </div>
    </div>
</div>



<!-- Include your script here -->
<script>
const user_id = "{{ request.user.id }}";
const lawyer_id = "{{ lawyer.id.id }}";
const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
const chatSocket = new WebSocket(ws_scheme + '://' + window.location.host + '/ws/call/' + user_id + '/' + lawyer_id + '/');

document.getElementById('startCallBtn').onclick = function() {
    chatSocket.send(JSON.stringify({
        'action': 'call',
        'target': lawyer_id,
    }));
};

chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    if (data.action === 'incoming_call') {
        // Show modal to accept or reject
        const modal = new bootstrap.Modal(document.getElementById('incomingCallModal'));
        modal.show();

        document.getElementById('acceptCallBtn').onclick = function() {
            chatSocket.send(JSON.stringify({'action': 'accept_call', 'target': data.from}));
            modal.hide();
            startVideoCall();
        };

        document.getElementById('rejectCallBtn').onclick = function() {
            chatSocket.send(JSON.stringify({'action': 'reject_call', 'target': data.from}));
            modal.hide();
        };
    } else if (data.action === 'call_accepted') {
        startVideoCall();
    } else if (data.action === 'call_rejected') {
        alert("Call was rejected.");
    }
};

function startVideoCall() {
    alert("Starting video call... (WebRTC setup goes here)");
    // WebRTC setup for video call here
}
</script>
{% endblock %}
